<!DOCTYPE html>
<html>

<head>
  <title>{{title}}</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
        crossorigin="anonymous">
  <link rel='stylesheet' href='/stylesheets/style.css'/>
  <link rel='stylesheet' href='/stylesheets/bulma.css'/>
  <script src='/javascripts/lib.js'></script>
</head>

<body>

{{#if error}}

{{else}}
  <nav class="navbar">

    <div class="navbar-brand">
      <a class="navbar-item">
        <img src="/images/logo.png" width="30" height="30" alt="Logo">
      </a>
    </div>

    <div class="navbar-menu">
      <div class="navbar-start">
        <a href="/user/profile" class="navbar-item"> Home </a>
        <a href="/module/search" class="navbar-item"> Search </a>
        <a href="/module/create" class="navbar-item"> Create </a>
        <a href="/about" class="navbar-item"> About Us </a>
      </div>
    </div>

    {{#if loggedIn}}
      <div class="navbar-end">
        {{#if loggedin.firstname}}
          <a href="" class="navbar-item"> Hi {{loggedIn.firstName}}!</a>
        {{else}}
          <a href="" id="user-name" class="navbar-item"> Hi {{loggedIn.email}}!</a>
          <script>
            (function() {
              const el = document.getElementById('user-name');
              const regex = /(.*)@(.*)/;
              const result = regex.exec(el.innerText);
              if (result !== null) el.innerText = result[1];
            })();
          </script>
        {{/if}}
        <div class="navbar-item has-dropdown is-hoverable">
          <a href="/user" class="navbar-link">Account Overview</a>
          <div class="navbar-dropdown">
            <a href="/user/settings" class="navbar-item">Settings</a>
            <a href="/help" class="navbar-item">Help</a>
            <hr class="navbar-divider">
            <a href="#" id="logout-btn" class="navbar-item">Log out</a>
            <script>
              (function() {
                document.getElementById('logout-btn').onclick = () => {
                  const cfg = {
                    method: 'GET',
                    redirect: 'follow',
                    cache: 'no-cache',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json',
                    },
                  };
                  return fetch('/api/user/logout', cfg).then(response => {
                    window.location = '/user/register';
                  });
                };
              })();
            </script>
          </div>
        </div>
      </div>
    {{else}}
      <form action="" method='post'>
        <div class="navbar-end">
          <div class="navbar-item">
            <div class="control has-icons-left">
              <input name="email" class="input is-success is-small" id="email" type="email" placeholder="email"
                     autocomplete="on" maxlength="255" pattern=".{2,}@.{2,}\..{2,}" required>
              <span class="icon is-small is-left">
                    <i class="fa fa-envelope"></i>
                  </span>
            </div>
          </div>
          <div class="navbar-item">
            <div class="control has-icons-left">
              <input name="password" class="input is-success is-small" id="password" type="password"
                     placeholder="password"
                     pattern=".{6,}" required>
              <span class="icon is-small is-left">
                    <i class="fa fa-lock"></i>
                  </span>
            </div>
          </div>
          <div class="navbar-item">
            <input type="submit" id="login-btn" value="Log In" class="button is-primary is-small">
          </div>
        </div>
      </form>
      <script>
        (function() {
          document.getElementById('login-btn').onclick = (event) => {

            // don't send the HTML form
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const credentials = {
              email,
              password,
            };

            const cfg = {
              method: 'POST',
              redirect: 'follow',
              cache: 'no-cache',
              mode: 'cors',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
              },
              body: JSON.stringify(credentials),
            };

            // error codes 400..499 and 500..599 are client and server errors
            return fetch(`/api/user/login`, cfg)
                .then(response => response.status >= 400 ?
                    // if it goes wrong force it to jump to reject
                    Promise.reject(response.json()) :
                    // the JSON object is guaranteed to have a "msg" property
                    response.json())
                .then(json => {
                  // result should store the token if things go well
                  const token = json.result;
                  setCookie('token', token);
                  // redirect
                  window.location = '/user/profile';
                })
                .catch(err => {
                  console.error(err);
                  return err.then(e => alert(e.msg || e.message || e.toString()));
                });
          };
        })();
      </script>
    {{/if}}
  </nav>
{{/if}}

{{{body}}}

</body>
<footer class="footer">
  <div class="content has-text-centered">
    <p><a href="/about">About Us</a></p>
  </div>
</footer>
</html>
