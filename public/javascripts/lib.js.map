{"version":3,"sources":["lib.js"],"names":["SECOND","MINUTE","HOUR","getCookie","name","pairs","document","cookie","split","map","s","trim","pair","decodeURIComponent","dictionary","setCookie","value","opts","options","Object","assign","path","httpOnly","sameSite","encodeURIComponent","join","clearCookie","get","model","tryFetch","tryCache","memory","sessionStorage","getItem","location","pathname","toLowerCase","entries","query","console","debug","keys","JSON","parse","doSaveFetch","doSave","fetch","headers","Accept","credentials","redirect","cache","response","json","setItem","stringify","result","msg","message","toString","error","alert","force","create","postData","method","body","update","id","contentType","status","Promise","reject","destroy"],"mappings":"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","sourcesContent":["const SECOND = 1000;\r\nconst MINUTE = 60 * SECOND;\r\nconst HOUR = 60 * MINUTE;\r\n\r\n/**\r\n * Returns the value of a cookie.\r\n *\r\n * @param {!String} name\r\n * @return {?String} cookie value\r\n */\r\nfunction getCookie(name) {\r\n  const pairs = document.cookie\r\n      .split(';')\r\n      .map((s) => s.trim())\r\n      .map((s) => s.split('='))\r\n      .map((pair) => pair.map(decodeURIComponent));\r\n  const dictionary = {};\r\n  for (const pair of pairs) {\r\n    dictionary[pair[0]] = pair[1];\r\n  }\r\n  return dictionary[name];\r\n}\r\n\r\n/**\r\n * Sets the value of a cookie.\r\n *\r\n * @param {!String} name\r\n * @param {{path: String, sameSite: 'Strict' | 'Lax', expires: Date}} opts\r\n * @param {!String} value\r\n */\r\nfunction setCookie(name, value, opts = {}) {\r\n  const options = Object.assign({\r\n    path: '/',\r\n    httpOnly: false,\r\n    sameSite: 'Strict',\r\n    // expires: new Date(Date.now() + HOUR * 2),\r\n  }, opts);\r\n  document.cookie = [\r\n    [name, value].map(encodeURIComponent),\r\n    // ['Expires', options.expires.toGMTString()],\r\n    ['Path', options.path],\r\n    ['SameSite', options.sameSite]\r\n  ].map((pair) => pair.join('=')).join('; ');\r\n}\r\n\r\n/**\r\n * Clears a cookie.\r\n *\r\n * @param {!String} name\r\n */\r\nfunction clearCookie(name) {\r\n  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:01 GMT`;\r\n}\r\n\r\n/**\r\n * Query the database for objects.\r\n *\r\n * @param {'User', 'Module', 'Lesson', 'Question', 'Rating'} model\r\n * @param {!Object} query\r\n * @param {?Boolean} force\r\n * @return {Promise<!Array<{id: !Number, createdAt: !Date, updatedAt: !Date}>>}\r\n */\r\nasync function get(model, query = {}, force = true, doSave = false) {\r\n  async function tryFetch(doSaveFetch = doSave) {\r\n    try {\r\n      console.debug(`using AJAX for ${model} with ${Object.keys(query).join(', ')}`);\r\n      const response = await fetch(`/api/${model.toLowerCase()}/search?${Object.entries(query)\r\n        .map(pair => pair.join('='))\r\n        .join('&')}`, {\r\n        headers: {Accept: 'application/json'},\r\n        credentials: 'include',\r\n        redirect: 'follow',\r\n        cache: 'no-cache',\r\n      });\r\n      const json = await response.json();\r\n      if (doSaveFetch) {\r\n        sessionStorage.setItem(`${location.pathname}/${model.toLowerCase()}s?${Object.entries(query).map(pair => pair.join('=')).join('&')}`, JSON.stringify(json.result));\r\n      }\r\n      return json.result;\r\n    } catch (e) {\r\n      const msg = e.msg || e.message || e.toString();\r\n      console.error(msg);\r\n      return alert(msg);\r\n    }\r\n  }\r\n\r\n  function tryCache() {\r\n    const memory = sessionStorage.getItem(\r\n      `${location.pathname}/${model.toLowerCase()}s?${Object.entries(query)\r\n        .map(pair => pair.join('='))\r\n        .join('&')}`);\r\n    if (!memory) return false;\r\n    console.debug(\r\n      `using cache for ${model} with ${Object.keys(query).join(', ')}`);\r\n    return JSON.parse(memory);\r\n  }\r\n\r\n  return (force && await tryFetch()) || tryCache() || await tryFetch();\r\n}\r\n\r\n/**\r\n * Create a new object in the database.\r\n *\r\n * @param {'User', 'Module', 'Lesson', 'Question', 'Rating'} model\r\n * @param {!Blob|!BufferSource|!FormData|!URLSearchParams|!ReadableStream|!String} postData\r\n * @return {Promise<void|{id: !Number, createdAt: !Date, updatedAt: !Date}>} created object\r\n */\r\nasync function create(model, postData = '') {\r\n  try {\r\n    const response = await fetch(`/api/${model.toLowerCase()}/create`, {\r\n      method: 'post',\r\n      headers: {Accept: 'application/json', 'Content-Type': 'application/json'},\r\n      credentials: 'include',\r\n      redirect: 'follow',\r\n      body: postData,\r\n      cache: 'no-cache',\r\n    });\r\n    const json = await response.json();\r\n    return json.result;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return alert(e.msg || e.message || e.toString());\r\n  }\r\n}\r\n\r\n/**\r\n * Update an object in the database.\r\n *\r\n * @param {'User', 'Module', 'Lesson', 'Question', 'Rating'} model\r\n * @param {!Number} id\r\n * @param {!Blob|!BufferSource|!FormData|!URLSearchParams|!ReadableStream|!String} postData\r\n * @param {?String} contentType\r\n * @return {Promise<Response>} promise of updated object\r\n */\r\nasync function update(model, id, postData, contentType = 'application/json') {\r\n  const headers = {\r\n    Accept: [\r\n      'application/json',\r\n      'text/html',\r\n      'application/xhtml+xml',\r\n      'text/plain',\r\n      '*'].join(', '),\r\n  };\r\n  if (contentType) headers['Content-Type'] = contentType;\r\n  try {\r\n    const response = await fetch(`/api/${model.toLowerCase()}/${id}`, {\r\n      method: 'post',\r\n      headers,\r\n      credentials: 'include',\r\n      redirect: 'follow',\r\n      body: postData,\r\n      cache: 'no-cache',\r\n    });\r\n    const json = await response.json();\r\n    return response.status >= 400 ? Promise.reject(json.msg) : json.msg;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return alert(e.msg || e.message || e.toString());\r\n  }\r\n}\r\n\r\n/**\r\n * Destroy an object from the database.\r\n *\r\n * @param {'User', 'Module', 'Lesson', 'Question', 'Rating', 'File'} model\r\n * @param {!Number} id\r\n * @return {Promise<void|!String>}\r\n */\r\nasync function destroy(model, id) {\r\n  try {\r\n    const response = await fetch(`/api/${model.toLowerCase()}/${id}`, {\r\n      method: 'delete',\r\n      headers: {Accept: 'application/json'},\r\n      credentials: 'include',\r\n      redirect: 'follow',\r\n      cache: 'no-cache',\r\n    });\r\n    const json = await response.json();\r\n    return json.msg;\r\n  } catch (e) {\r\n    console.error(e);\r\n    return alert(e.msg || e.message || e.toString());\r\n  }\r\n}\r\n"]}